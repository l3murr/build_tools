#!/bin/sh
set -eu

check_minikube_install() {
    if [[ $(minikube 2>/dev/null)  =~ "minikube provisions and manages local Kubernetes" ]]; then
        return;
    fi
    echo "You must have minikube installed first"
    exit 0
}

check_minikube_running() {
    if [[ $(minikube status 2>/dev/null)  =~ "host: Running" ]]; then
        return;
    fi
    minikube start --listen-address=0.0.0.0 --embed-certs
}

main() {
    if [[ $# -gt 0 ]]; then
        profile=$1
    else
        profile="1"
    fi
    if [[ $# -gt 1 ]]; then
        host=$2
    else
        host="tmnp.net"
    fi
    if [[ $profile == "1" ]]; then
        app_port=8443
    fi
    if [[ $profile == "2" ]]; then
        app_port=8844
    fi
    if [[ $profile == "3" ]]; then
        app_port=8845
    fi
    if [[ $profile == "4" ]]; then
        app_port=8846
    fi
    check_minikube_install
    check_minikube_running
    minikube ssh "curl --silent https://raw.githubusercontent.com/l3murr/build_tools/refs/heads/main/dev-nginx-nip.Dockerfile | docker build -t tms-nginx:v2 -"
    minikube ssh "curl --silent https://raw.githubusercontent.com/l3murr/build_tools/refs/heads/main/dev-server.Dockerfile | docker build -t tms-server:v2 -"
    minikube ssh "curl --silent https://raw.githubusercontent.com/l3murr/build_tools/refs/heads/main/dev-mysql.Dockerfile | docker build -t tms-mysql:v2 -"
    minikube ssh "curl --silent https://raw.githubusercontent.com/l3murr/build_tools/refs/heads/main/dev-websocket.Dockerfile | docker build -t tms-websocket:v2 -"
    minikube ssh "curl --silent https://raw.githubusercontent.com/l3murr/build_tools/refs/heads/main/dev-dynamodb.Dockerfile | docker build -t tms-dynamodb:v2 -"
    minikube ssh "curl --silent https://raw.githubusercontent.com/l3murr/build_tools/refs/heads/main/dev-minio.Dockerfile | docker build -t tms-minio:v2 -"
    curl --silent https://raw.githubusercontent.com/l3murr/build_tools/refs/heads/main/kube.dev.yaml | sed "s/\\$\\$/$profile/g" | sed "s/\\^\\^/$host/g" | sed "s/\\*\\*/$app_port/g" | minikube kubectl apply -- -f -

    # Setup MinIO bucket
    echo "Setting up MinIO bucket for profile $profile..."

    # Wait for MinIO pod to be ready
    if minikube kubectl -- wait --for=condition=ready pod -l name=minio-$profile --timeout=120s; then
        echo "MinIO pod is ready, creating bucket from inside cluster..."
        sleep 5

        # Create bucket using kubectl exec (from inside cluster - more reliable)
        echo "Creating S3 bucket 'hl7-rules-dev' using internal cluster access..."

        # Run a temporary pod with curl to create the bucket from inside the cluster
        bucket_creation_result=$(minikube kubectl -- run minio-bucket-setup-$profile --image=curlimages/curl --rm -i --restart=Never --timeout=60s -- \
            sh -c "
            # Wait for MinIO to respond internally
            for i in {1..12}; do
                if curl -s -f http://minio-service-$profile.default.svc.cluster.local:9000/minio/health/live >/dev/null 2>&1; then
                    echo 'MinIO responding internally'
                    break
                fi
                echo 'Waiting for MinIO...'
                sleep 5
            done

            # Check if bucket exists
            status=\$(curl -s -o /dev/null -w '%{http_code}' http://minio-service-$profile.default.svc.cluster.local:9000/hl7-rules-dev --user 'minioadmin:minioadmin' 2>/dev/null || echo '000')

            if [ \"\$status\" != '200' ]; then
                echo 'Creating bucket...'
                if curl -X PUT http://minio-service-$profile.default.svc.cluster.local:9000/hl7-rules-dev --user 'minioadmin:minioadmin' -H 'Content-Length: 0' >/dev/null 2>&1; then
                    echo 'BUCKET_CREATED'
                else
                    echo 'BUCKET_FAILED'
                fi
            else
                echo 'BUCKET_EXISTS'
            fi
            " 2>/dev/null)

        # Parse the result
        if [[ "$bucket_creation_result" == *"BUCKET_CREATED"* ]]; then
            echo "✅ MinIO bucket 'hl7-rules-dev' created successfully"
        elif [[ "$bucket_creation_result" == *"BUCKET_EXISTS"* ]]; then
            echo "✅ MinIO bucket 'hl7-rules-dev' already exists"
        else
            echo "⚠️  MinIO bucket creation failed or timed out"
        fi

        # Get external access info
        minio_ip=$(minikube ip)
        api_port=$(minikube kubectl -- get service minio-service-$profile -o jsonpath='{.spec.ports[0].nodePort}' 2>/dev/null || echo "N/A")
        console_port=$(minikube kubectl -- get service minio-service-$profile -o jsonpath='{.spec.ports[1].nodePort}' 2>/dev/null || echo "N/A")

        echo "MinIO Console: http://$minio_ip:$console_port"
        echo "MinIO API: http://$minio_ip:$api_port"
        echo "Credentials: minioadmin / minioadmin"
    else
        echo "⚠️  MinIO pod failed to become ready, bucket setup skipped"
    fi

    keys=($(ls ~/.ssh))
    SSH_REGEX='^id_[a-zA-Z0-9]*'
    PK_REGEX='^id_[a-zA-Z0-9]*$'
    for i in "${keys[@]}"; do
        if [[ "$i" =~ $SSH_REGEX ]]; then
            minikube cp "$HOME/.ssh/$i" "minikube:/data/home/.ssh/$i"
        fi
        if [[ "$i" =~ $PK_REGEX ]]; then
            minikube ssh "sudo chmod 400 /data/home/.ssh/$i"
        fi
    done
    nginx=$(minikube kubectl get pods | grep -o 'nginx-[0-9a-z-]*')
    mysql=$(minikube kubectl get pods | grep -o "mysql-$profile-[0-9a-z-]*")
    minikube ssh "sudo chmod 0777 -R /data/nosql_1"
}

main "$@"
